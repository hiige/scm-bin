#!/usr/bin/env scm
(import
 (chibi) (chibi string)
 (chibi char-set) (chibi io)
 (chibi process) (srfi 1))

(define (strip-right str pred)
  (substring-cursor str
                    (string-find str pred)))

(define (strip-left str pred)
  (substring-cursor str
                    (string-cursor-start str)
                    (string-find str pred)))

(define (first-char str)
  (string-cursor-ref str
                     (string-cursor-start str)))

(define (chars c n)
  (take (circular-list c) n))

(define (strip-whitespace str)
  (strip-right str
               (char-set #\  #\	)))

(define (string-prev-ref str i)
  (string-cursor-ref str
                     (string-cursor-prev str i)))

(define (substring-cursor-next str i . o)
  (apply
   substring-cursor
   str
   (cons
    (string-cursor-next str i)
    o)))

(define (string-lit? str i)
  (let ((j (string-cursor-prev str i))
         (st (string-cursor-start str)))
    (cond
      ((string-cursor<=? j st) #f)
      ((eq? #\\ (string-cursor-ref str j))
        (let ((k (string-cursor-prev str j)))
          (if (and (string-cursor>? k st)
                   (eq? #\\ (string-cursor-ref str k)))
            (string-lit? str k)
            #f)))
    (else #t))))

(define (string-nonlit? str i) (not (string-lit? str i)))

(define (string-find-nonlit str c)
  (let loop ((cur str) (idx 0))
    (if (eq? c (first-char cur))
      (string-cursor-start str)
      (let ((i (string-find cur c))
             (end (string-cursor-end cur)))
        (cond
          ((string-cursor>=? i end)
           (string-cursor-end str))
          ((string-nonlit? cur i)
           (loop
            (substring-cursor-next cur i end)
            (+ idx (string-cursor->index cur i))))
          (else
            (string-index->cursor str
             (+ idx (string-cursor->index cur i)))))))))

(define (string-cursor+index str i n)
  (string-index->cursor str
   (+ n
    (string-cursor->index str i))))

(define (string-cursor-diff str i j)
  (abs
   (-
    (string-cursor->index str j)
    (string-cursor->index str i))))

(define (debug v)
  (begin
   (write-line v)
   v))

(define (paren-val c)
  (+ 1
   (* 2
    (- (char->integer #\()
        (char->integer c)))))

(define (open-parens str)
  (let loop ((s str) (c 0))
    (let*
     ((idx (string-find s (char-set #\) #\()))
      (cur (substring-cursor
            s
            idx
            (string-cursor-end s)))
      (i (string-cursor-start cur)))
       (cond
         ((string-null? cur) c)
         ((string-lit? cur i)
          (loop
           (substring-cursor cur
            (string-cursor-next cur i))
           c))
         (else
           (let
            ((j
              (string-skip cur
                           (string-cursor-ref cur i))))
             (loop
              (substring-cursor cur
                                j
                                (string-cursor-end cur))
              (+ c
                 (* (string-cursor-diff cur i j)
                     (paren-val (string-cursor-ref cur i)))))))))))

(define (line-accumulator f op b)
  (let* ((line (read-line))
         (r (f line)))
           (if (null? r) b
             (line-accumulator f op (op r b)))))

(define (string-trim-upto str pred)
  (let ((i (string-find str pred))
        (end (string-cursor-end str)))
    (if (string-cursor=? i end) ""
      (substring-cursor str
                        (string-cursor-next str i)
                        end))))

(define (string-unqouted str)
  (let loop ((cur str)
              (res ""))
    (let ((i (string-find cur #\")))
      (cond
        ((string-null? cur) res)
        ((string-cursor=? i
                          (string-cursor-end cur))
         (string-append res cur))
        (else
          (loop
           (string-trim-upto
            (substring-cursor cur
                              (string-cursor-next cur i))
             #\")
           (string-append res
                   (substring-cursor cur
                                     (string-cursor-start cur)
                                     i))))))))
                      


(let ((c
       (line-accumulator
        (lambda (line)
          (if (eof-object? line) '()
            (let* ((i (string-find-nonlit line #\;))
                   (text
                    (string-unqouted
                     (if (string-cursor<? i
                          (string-cursor-end line))
                       (substring-cursor line
                                         (string-cursor-start line)
                                         i)
                       line))))
             (if (= 0 (string-length text)) 0
               (open-parens text)))))
        +
        0)))
  (if (> c 0)
    (write-line
     (apply string
            (chars #\)
            c)))))
      
